##@ ðŸŽ¬ Setup & InstalaÃ§Ã£o

setup: ## Setup inicial completo do projeto
	@echo "$(GREEN)ðŸŽ¬ Configurando projeto Laravel...$(NC)"
	@echo "$(YELLOW)ðŸ“‹ 1/5 Copiando .env...$(NC)"
	cp --update=none backend/.env.example backend/.env
	@echo "$(YELLOW)ðŸ“¦ 2/5 Instalando dependÃªncias Composer...$(NC)"
	docker compose exec php composer install
	@echo "$(YELLOW)ðŸ”‘ 3/5 Gerando chave da aplicaÃ§Ã£o...$(NC)"
	docker compose exec php php artisan key:generate
	@echo "$(YELLOW)ðŸ—„ï¸  4/5 Executando migrations...$(NC)"
	docker compose exec php php artisan migrate
	@echo "$(YELLOW)ðŸ”— 5/5 Criando link de storage...$(NC)"
	docker compose exec php php artisan storage:link
	@echo "$(GREEN)âœ… Setup concluÃ­do!$(NC)"

setup-full: ## Setup completo com seed
	@echo "$(GREEN)ðŸŽ¬ Setup completo com seed...$(NC)"
	$(MAKE) setup
	@echo "$(YELLOW)ðŸŒ± Executando seeders...$(NC)"
	docker compose exec php php artisan db:seed
	@echo "$(GREEN)âœ… Setup completo concluÃ­do!$(NC)"

install: ## Apenas instala dependÃªncias Composer
	@echo "$(YELLOW)ðŸ“¦ Instalando dependÃªncias...$(NC)"
	docker compose exec php composer install

install-dev: ## Instala dependÃªncias de desenvolvimento
	@echo "$(YELLOW)ðŸ“¦ Instalando dependÃªncias de dev...$(NC)"
	docker compose exec php composer install --dev

update: ## Atualiza dependÃªncias Composer
	@echo "$(YELLOW)â¬†ï¸  Atualizando dependÃªncias...$(NC)"
	docker compose exec php composer update


##@ ðŸš€ Workflows RÃ¡pidos

dev: up logs ## Inicia e mostra logs

quick-start: up setup ## Start rÃ¡pido com setup

rebuild-all: down up-build migrate ## Rebuild completo

fresh: migrate-fresh-seed clear-all ## Fresh start com seed

deploy-prep: ## Prepara para deploy
	@echo "$(GREEN)ðŸš€ Preparando para deploy...$(NC)"
	$(MAKE) test
	$(MAKE) production-ready
	@echo "$(GREEN)âœ… Pronto para deploy!$(NC)"


##@ ðŸŽ¯ Workflows Completos

full-reset: ## Reset completo do projeto
	@echo "$(YELLOW)ðŸ”„ Fazendo reset completo...$(NC)"
	$(MAKE) down-volumes
	$(MAKE) up-build
	$(MAKE) setup-full
	$(MAKE) clear-all
	@echo "$(GREEN)âœ… Reset completo finalizado!$(NC)"

daily-start: ## Rotina diÃ¡ria de inÃ­cio
	@echo "$(BLUE)â˜€ï¸  Bom dia! Iniciando ambiente...$(NC)"
	docker compose up -d
	$(MAKE) health
	docker compose exec php php artisan migrate:status
	@echo "$(GREEN)âœ… Ambiente pronto para trabalhar!$(NC)"

before-commit: ## Checklist antes de commit
	@echo "$(YELLOW)ðŸ“‹ Executando checklist...$(NC)"
	@echo "1ï¸âƒ£  Executando testes..."
	$(MAKE) test
	@echo "2ï¸âƒ£  Validando cÃ³digo..."
	docker compose exec php ./vendor/bin/phpstan analyse || true
	docker compose exec php ./vendor/bin/php-cs-fixer fix --dry-run || true
	@echo "3ï¸âƒ£  Verificando migrations..."
	docker compose exec php php artisan migrate:status
	@echo "$(GREEN)âœ… Checklist concluÃ­do!$(NC)"

deploy-production: ## Workflow de deploy para produÃ§Ã£o
	@echo "$(RED)ðŸš€ Deploy para PRODUÃ‡ÃƒO$(NC)"
	@read -p "Confirma deploy? [s/N]: " confirm; \
	if [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ]; then \
		echo "$(YELLOW)1/6 Executando testes...$(NC)"; \
		$(MAKE) test; \
		echo "$(YELLOW)2/6 Fazendo backup...$(NC)"; \
		$(MAKE) backup-db; \
		echo "$(YELLOW)3/6 Atualizando dependÃªncias...$(NC)"; \
		$(MAKE) composer-install; \
		echo "$(YELLOW)4/6 Executando migrations...$(NC)"; \
		$(MAKE) migrate; \
		echo "$(YELLOW)5/6 Otimizando...$(NC)"; \
		$(MAKE) production-ready; \
		echo "$(YELLOW)6/6 Reiniciando serviÃ§os...$(NC)"; \
		$(MAKE) restart; \
		echo "$(GREEN)âœ… Deploy concluÃ­do com sucesso!$(NC)"; \
	else \
		echo "Deploy cancelado."; \
	fi


##@ ðŸ—ï¸  Montagem de Ambiente AutomÃ¡tica

check-structure: ## Verifica e cria estrutura de pastas necessÃ¡rias
	@echo "$(YELLOW)ðŸ” Verificando estrutura...$(NC)"
	@mkdir -p backend/storage/logs
	@mkdir -p backend/storage/framework/cache
	@mkdir -p backend/storage/framework/sessions
	@mkdir -p backend/storage/framework/views
	@mkdir -p backend/bootstrap/cache
	@mkdir -p backups
	@echo "$(GREEN)âœ… Estrutura verificada!$(NC)"

create-env-from-compose: ## Cria .env baseado no docker-compose.yml
	@echo "$(YELLOW)ðŸ“ Criando .env a partir do docker-compose.yml...$(NC)"
	@if [ ! -f backend/.env ]; then \
		cp backend/.env.example backend/.env; \
		echo "" >> backend/.env; \
		echo "# ConfiguraÃ§Ãµes dos Containers" >> backend/.env; \
		echo "DB_HOST=mysql" >> backend/.env; \
		echo "DB_PORT=3306" >> backend/.env; \
		echo "DB_DATABASE=db_laravel" >> backend/.env; \
		echo "DB_USERNAME=developer" >> backend/.env; \
		echo "DB_PASSWORD=123456" >> backend/.env; \
		echo "REDIS_HOST=redis" >> backend/.env; \
		echo "REDIS_PORT=6379" >> backend/.env; \
		echo "MAIL_MAILER=smtp" >> backend/.env; \
		echo "MAIL_HOST=mailer" >> backend/.env; \
		echo "MAIL_PORT=1025" >> backend/.env; \
		echo "MAIL_ENCRYPTION=null" >> backend/.env; \
		echo "$(GREEN)âœ… .env criado com configuraÃ§Ãµes dos containers!$(NC)"; \
	else \
		echo "$(YELLOW).env jÃ¡ existe$(NC)"; \
	fi

sync-env-with-compose: ## Sincroniza .env existente com docker-compose.yml
	@echo "$(YELLOW)ðŸ”„ Sincronizando .env com containers...$(NC)"
	@if [ -f backend/.env ]; then \
		sed -i.bak 's/^DB_HOST=.*/DB_HOST=mysql/' backend/.env; \
		sed -i.bak 's/^DB_DATABASE=.*/DB_DATABASE=db_laravel/' backend/.env; \
		sed -i.bak 's/^DB_USERNAME=.*/DB_USERNAME=developer/' backend/.env; \
		sed -i.bak 's/^DB_PASSWORD=.*/DB_PASSWORD=123456/' backend/.env; \
		sed -i.bak 's/^REDIS_HOST=.*/REDIS_HOST=redis/' backend/.env; \
		sed -i.bak 's/^MAIL_HOST=.*/MAIL_HOST=mailer/' backend/.env; \
		rm -f backend/.env.bak; \
		echo "$(GREEN)âœ… .env sincronizado!$(NC)"; \
	else \
		echo "$(RED)âŒ .env nÃ£o encontrado!$(NC)"; \
		echo "$(YELLOW)Use: make create-env-from-compose$(NC)"; \
	fi

environment-setup: ## Setup completo do ambiente (containers + Laravel)
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(GREEN)ðŸ—ï¸  Montando Ambiente Completo$(NC)"
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸ“¦ 1/8 Verificando estrutura de pastas...$(NC)"
	$(MAKE) check-structure
	@echo ""
	@echo "$(YELLOW)ðŸ³ 2/8 Subindo containers...$(NC)"
	docker compose up -d
	@echo ""
	@echo "$(YELLOW)â³ 3/8 Aguardando containers ficarem prontos...$(NC)"
	@sleep 10
	$(MAKE) health
	@echo ""
	@echo "$(YELLOW)ðŸ“ 4/8 Configurando .env...$(NC)"
	$(MAKE) create-env-from-compose
	@echo ""
	@echo "$(YELLOW)ðŸ“¦ 5/8 Instalando dependÃªncias...$(NC)"
	docker compose exec php composer install
	@echo ""
	@echo "$(YELLOW)ðŸ”‘ 6/8 Gerando chave da aplicaÃ§Ã£o...$(NC)"
	docker compose exec php php artisan key:generate
	@echo ""
	@echo "$(YELLOW)ðŸ—„ï¸  7/8 Configurando banco de dados...$(NC)"
	docker compose exec php php artisan migrate
	@echo ""
	@echo "$(YELLOW)ðŸ”— 8/8 Configurando storage...$(NC)"
	docker compose exec php php artisan storage:link
	@echo ""
	@echo "$(GREEN)âœ… Ambiente montado com sucesso!$(NC)"
	@echo ""
	$(MAKE) info

auto-config: ## Configura automaticamente todos os serviÃ§os
	@echo "$(GREEN)âš™ï¸  ConfiguraÃ§Ã£o automÃ¡tica dos serviÃ§os...$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸ˜ Configurando PHP...$(NC)"
	@docker compose exec php php -v | head -1
	@echo ""
	@echo "$(YELLOW)ðŸ—„ï¸  Testando MySQL...$(NC)"
	@docker compose exec mysql mysqladmin -u root -proot ping && echo "$(GREEN)âœ“ MySQL OK$(NC)" || echo "$(RED)âœ— MySQL com problema$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸ”´ Testando Redis...$(NC)"
	@docker compose exec redis redis-cli ping && echo "$(GREEN)âœ“ Redis OK$(NC)" || echo "$(RED)âœ— Redis com problema$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸŒ Testando Nginx...$(NC)"
	@docker compose exec nginx nginx -t 2>&1 && echo "$(GREEN)âœ“ Nginx OK$(NC)" || echo "$(RED)âœ— Nginx com problema$(NC)"
	@echo ""
	@echo "$(GREEN)âœ… ConfiguraÃ§Ã£o concluÃ­da!$(NC)"

validate-containers: ## Valida se todos containers estÃ£o configurados corretamente
	@echo "$(YELLOW)ðŸ” Validando containers...$(NC)"
	@echo ""
	@echo "$(BLUE)Container PHP:$(NC)"
	@docker compose exec php php --version | head -1
	@docker compose exec php composer --version | head -1
	@echo ""
	@echo "$(BLUE)Container MySQL:$(NC)"
	@docker compose exec mysql mysql --version
	@docker compose exec mysql mysql -u root -proot -e "SELECT VERSION();" 2>/dev/null || echo "$(RED)Erro ao conectar$(NC)"
	@echo ""
	@echo "$(BLUE)Container Redis:$(NC)"
	@docker compose exec redis redis-server --version
	@docker compose exec redis redis-cli info server | grep redis_version
	@echo ""
	@echo "$(BLUE)Container Nginx:$(NC)"
	@docker compose exec nginx nginx -v 2>&1
	@echo ""
	@echo "$(GREEN)âœ… ValidaÃ§Ã£o concluÃ­da!$(NC)"

show-container-config: ## Mostra configuraÃ§Ã£o atual dos containers
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(GREEN)ðŸ“‹ ConfiguraÃ§Ã£o dos Containers$(NC)"
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸ˜ PHP:$(NC)"
	@echo "  Container: setup-laravel-php"
	@echo "  Volume: ./backend â†’ /var/www"
	@docker compose exec php php -r "echo '  PHP Version: ' . PHP_VERSION . PHP_EOL;" 2>/dev/null || echo "  Container nÃ£o estÃ¡ rodando"
	@echo ""
	@echo "$(YELLOW)ðŸ—„ï¸  MySQL:$(NC)"
	@echo "  Container: setup-laravel-mysql"
	@echo "  Database: db_laravel"
	@echo "  Port: 3306"
	@echo "  User: developer / root"
	@docker compose exec mysql mysql --version 2>/dev/null || echo "  Container nÃ£o estÃ¡ rodando"
	@echo ""
	@echo "$(YELLOW)ðŸ”´ Redis:$(NC)"
	@echo "  Container: setup-laravel-redis"
	@echo "  Port: 6379"
	@docker compose exec redis redis-cli INFO server 2>/dev/null | grep redis_version || echo "  Container nÃ£o estÃ¡ rodando"
	@echo ""
	@echo "$(YELLOW)ðŸŒ Nginx:$(NC)"
	@echo "  Container: setup-laravel-nginx"
	@echo "  Ports: 8080:80, 443:443"
	@docker compose exec nginx nginx -v 2>&1 || echo "  Container nÃ£o estÃ¡ rodando"
	@echo ""
	@echo "$(YELLOW)ðŸ“§ Mailpit:$(NC)"
	@echo "  Container: setup-laravel-mailer"
	@echo "  Web UI: http://localhost:32770"
	@echo "  SMTP: 1025"

inspect-compose: ## Analisa docker-compose.yml e mostra serviÃ§os
	@echo "$(BLUE)ðŸ“‹ ServiÃ§os definidos no docker-compose.yml:$(NC)"
	@echo ""
	@docker compose config --services
	@echo ""
	@echo "$(BLUE)ðŸ” Detalhes dos containers:$(NC)"
	@docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
	@echo ""
	@echo "$(BLUE)ðŸ“Š Networks:$(NC)"
	@docker compose config --format json | grep -o '"setup-laravel-network"' | uniq || echo "setup-laravel-network"
	@echo ""
	@echo "$(BLUE)ðŸ’¾ Volumes:$(NC)"
	@docker compose config --volumes

init-project: ## Inicializa projeto do zero (primeira vez) ðŸŒŸ
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(GREEN)ðŸŽ‰ Inicializando Projeto Laravel com Docker$(NC)"
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo ""
	@echo "$(YELLOW)Este comando vai:$(NC)"
	@echo "  1. Criar estrutura de pastas"
	@echo "  2. Construir e iniciar containers"
	@echo "  3. Configurar .env com dados dos containers"
	@echo "  4. Instalar dependÃªncias"
	@echo "  5. Configurar Laravel"
	@echo "  6. Executar migrations"
	@echo ""
	@read -p "Continuar? [s/N]: " confirm; \
	if [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ]; then \
		$(MAKE) environment-setup; \
		echo ""; \
		echo "$(GREEN)ðŸŽ‰ Projeto inicializado com sucesso!$(NC)"; \
		echo ""; \
		echo "$(YELLOW)Acesse:$(NC)"; \
		echo "  AplicaÃ§Ã£o: http://localhost:8080"; \
		echo "  Mailpit: http://localhost:32770"; \
		echo ""; \
		echo "$(YELLOW)Comandos Ãºteis:$(NC)"; \
		echo "  make help        - Ver todos comandos"; \
		echo "  make bash        - Acessar container PHP"; \
		echo "  make db          - Acessar MySQL"; \
		echo "  make psql        - Acessar PostgreSQL"; \
		echo "  make mongo       - Acessar MongoDB"; \
		echo "  make redis-cli   - Acessar Redis"; \
		echo "  make logs        - Ver logs"; \
	else \
		echo "Cancelado."; \
	fi

verify-environment: ## Verifica se o ambiente estÃ¡ pronto para uso
	@echo "$(BLUE)ðŸ” Verificando ambiente...$(NC)"
	@echo ""
	@echo "$(YELLOW)1. Verificando Docker...$(NC)"
	@docker --version || (echo "$(RED)Docker nÃ£o instalado$(NC)" && exit 1)
	@echo "$(GREEN)âœ“ Docker OK$(NC)"
	@echo ""
	@echo "$(YELLOW)2. Verificando Docker Compose...$(NC)"
	@docker compose version || (echo "$(RED)Docker Compose nÃ£o instalado$(NC)" && exit 1)
	@echo "$(GREEN)âœ“ Docker Compose OK$(NC)"
	@echo ""
	@echo "$(YELLOW)3. Verificando containers...$(NC)"
	@docker compose ps | grep -q "Up" && echo "$(GREEN)âœ“ Containers rodando$(NC)" || echo "$(YELLOW)! Containers nÃ£o estÃ£o rodando (use: make up)$(NC)"
	@echo ""
	@echo "$(YELLOW)4. Verificando arquivos...$(NC)"
	@[ -f "docker-compose.yml" ] && echo "$(GREEN)âœ“ docker-compose.yml OK$(NC)" || echo "$(RED)âœ— docker-compose.yml nÃ£o encontrado$(NC)"
	@[ -f "backend/.env" ] && echo "$(GREEN)âœ“ .env OK$(NC)" || echo "$(YELLOW)! .env nÃ£o encontrado (use: make create-env-from-compose)$(NC)"
	@[ -d "backend/vendor" ] && echo "$(GREEN)âœ“ DependÃªncias instaladas$(NC)" || echo "$(YELLOW)! Vendor nÃ£o encontrado (use: make install)$(NC)"
	@echo ""
	@echo "$(GREEN)âœ… VerificaÃ§Ã£o concluÃ­da!$(NC)"

fix-permissions-auto: ## Corrige permissÃµes automaticamente
	@echo "$(YELLOW)ðŸ” Corrigindo permissÃµes...$(NC)"
	docker compose exec php chmod -R 775 storage bootstrap/cache 2>/dev/null || true
	docker compose exec php chown -R www-data:www-data storage bootstrap/cache 2>/dev/null || true
	@echo "$(GREEN)âœ… PermissÃµes corrigidas!$(NC)"

container-health-check: ## Verifica saÃºde de cada container individualmente
	@echo "$(BLUE)ðŸ¥ Health Check Individual dos Containers$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸ˜ PHP-FPM:$(NC)"
	@docker compose exec php php-fpm -t 2>&1 | grep -q "configuration file" && echo "$(GREEN)âœ“ Healthy$(NC)" || echo "$(RED)âœ— Unhealthy$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸ—„ï¸  MySQL:$(NC)"
	@docker compose exec mysql mysqladmin -u root -proot ping 2>/dev/null | grep -q "alive" && echo "$(GREEN)âœ“ Healthy$(NC)" || echo "$(RED)âœ— Unhealthy$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸ”´ Redis:$(NC)"
	@docker compose exec redis redis-cli ping 2>/dev/null | grep -q "PONG" && echo "$(GREEN)âœ“ Healthy$(NC)" || echo "$(RED)âœ— Unhealthy$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸŒ Nginx:$(NC)"
	@docker compose exec nginx nginx -t 2>&1 | grep -q "successful" && echo "$(GREEN)âœ“ Healthy$(NC)" || echo "$(RED)âœ— Unhealthy$(NC)"


##@ ðŸŽ¯ Aliases Ãšteis

dev-mode: clear-all optimize-clear ## Modo desenvolvimento (sem cache)
	@echo "$(GREEN)âœ… Modo desenvolvimento ativado!$(NC)"

prod-mode: production-ready ## Modo produÃ§Ã£o (com cache)
	@echo "$(GREEN)âœ… Modo produÃ§Ã£o ativado!$(NC)"

fresh-install: down up setup-full ## InstalaÃ§Ã£o limpa completa
	@echo "$(GREEN)âœ… InstalaÃ§Ã£o limpa concluÃ­da!$(NC)"

