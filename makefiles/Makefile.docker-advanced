##@ ğŸ³ Docker - Gerenciamento AvanÃ§ado

docker-stats: ## Mostra uso de recursos dos containers
	docker stats --no-stream

docker-stats-live: ## Monitora recursos em tempo real
	docker stats

docker-top-php: ## Mostra processos do container PHP
	docker compose top php

docker-top-all: ## Mostra processos de todos containers
	docker compose top

docker-inspect-php: ## Inspeciona container PHP
	docker compose exec php sh -c "cat /etc/os-release && php -v && composer -V"

docker-inspect-nginx: ## Inspeciona container Nginx
	docker compose exec nginx sh -c "cat /etc/os-release && nginx -v"

docker-inspect-mysql: ## Inspeciona container MySQL
	docker compose exec mysql sh -c "mysql --version"

docker-disk: ## Mostra uso de disco do Docker
	docker system df

docker-disk-verbose: ## Uso de disco detalhado
	docker system df -v


##@ ğŸ—‚ï¸  Docker - Volumes

volume-list: ## Lista todos os volumes
	docker volume ls

volume-inspect: ## Inspeciona volume especÃ­fico
	@read -p "Nome do volume: " vol; \
	docker volume inspect $$vol

volume-prune: ## Remove volumes nÃ£o utilizados
	@echo "$(RED)âš ï¸  ATENÃ‡ÃƒO: Remove volumes nÃ£o utilizados!$(NC)"
	@read -p "Confirma? [s/N]: " confirm; \
	if [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ]; then \
		docker volume prune; \
	fi

volume-backup: ## Backup de um volume
	@read -p "Nome do volume: " vol; \
	read -p "Nome do arquivo de backup (ex: backup.tar): " file; \
	docker run --rm -v $$vol:/source -v $$(pwd)/backups:/backup alpine tar czf /backup/$$file -C /source .

volume-restore: ## Restaura backup de volume
	@read -p "Nome do volume: " vol; \
	read -p "Nome do arquivo (em backups/): " file; \
	docker run --rm -v $$vol:/target -v $$(pwd)/backups:/backup alpine sh -c "cd /target && tar xzf /backup/$$file"


##@ ğŸŒ Docker - Networks

network-list: ## Lista networks
	docker network ls

network-inspect: ## Inspeciona network
	docker network inspect setup-laravel-network

network-prune: ## Remove networks nÃ£o utilizadas
	docker network prune


##@ ğŸ“¦ Docker - Images

image-prune: ## Remove imagens nÃ£o utilizadas
	docker image prune

image-prune-all: ## Remove TODAS imagens nÃ£o usadas
	@echo "$(RED)âš ï¸  Remove todas imagens nÃ£o utilizadas!$(NC)"
	@read -p "Confirma? [s/N]: " confirm; \
	if [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ]; then \
		docker image prune -a; \
	fi

image-size: ## Mostra tamanho das imagens
	docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

image-list: ## Lista todas imagens
	docker images

image-list-dangling: ## Lista imagens Ã³rfÃ£s (dangling)
	docker images --filter "dangling=true"

image-remove: ## Remove imagem especÃ­fica
	@read -p "ID ou nome:tag da imagem: " img; \
	docker rmi $$img && echo "$(GREEN)âœ… Imagem removida!$(NC)"

image-remove-dangling: ## Remove imagens Ã³rfÃ£s (dangling)
	@echo "$(YELLOW)ğŸ—‘ï¸  Removendo imagens Ã³rfÃ£s...$(NC)"
	docker image prune -f
	@echo "$(GREEN)âœ… Imagens Ã³rfÃ£s removidas!$(NC)"

image-remove-by-name: ## Remove imagens por nome/padrÃ£o
	@read -p "PadrÃ£o do nome (ex: setup-laravel-*): " pattern; \
	docker images --filter "reference=$$pattern" --format "{{.ID}}" | xargs -r docker rmi -f && \
	echo "$(GREEN)âœ… Imagens removidas!$(NC)"

image-remove-project: ## Remove imagens do projeto atual
	@echo "$(YELLOW)ğŸ—‘ï¸  Removendo imagens do projeto...$(NC)"
	@docker compose down --rmi local 2>/dev/null || true
	@echo "$(GREEN)âœ… Imagens do projeto removidas!$(NC)"

image-remove-all: ## Remove TODAS imagens (âš ï¸ CUIDADO!)
	@echo "$(RED)âš ï¸âš ï¸âš ï¸  Isso vai remover TODAS as imagens! âš ï¸âš ï¸âš ï¸$(NC)"
	@read -p "Digite 'CONFIRMO' para continuar: " confirm; \
	if [ "$$confirm" = "CONFIRMO" ]; then \
		docker rmi -f $$(docker images -q) 2>/dev/null || echo "Nenhuma imagem para remover"; \
		echo "$(GREEN)âœ… Todas imagens removidas!$(NC)"; \
	else \
		echo "Cancelado."; \
	fi

pull-latest: ## Atualiza imagens base
	docker compose pull


##@ ğŸ“‹ Docker - Containers AvanÃ§ado

container-list-all: ## Lista TODOS containers (incluindo parados)
	docker ps -a

container-list-stopped: ## Lista apenas containers parados
	docker ps -a --filter "status=exited"

container-remove-stopped: ## Remove todos containers parados
	@echo "$(YELLOW)ğŸ—‘ï¸  Removendo containers parados...$(NC)"
	docker container prune -f
	@echo "$(GREEN)âœ… Containers parados removidos!$(NC)"

container-remove-all-stopped: ## Remove containers parados (interativo)
	@echo "$(YELLOW)ğŸ—‘ï¸  Containers parados:$(NC)"
	@docker ps -a --filter "status=exited" --format "table {{.ID}}\t{{.Names}}\t{{.Status}}"
	@echo ""
	@read -p "Remover todos? [s/N]: " confirm; \
	if [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ]; then \
		docker container prune -f; \
		echo "$(GREEN)âœ… Removidos!$(NC)"; \
	else \
		echo "Cancelado."; \
	fi

container-remove: ## Remove container especÃ­fico
	@read -p "ID ou nome do container: " name; \
	docker rm -f $$name && echo "$(GREEN)âœ… Container removido!$(NC)"

container-stop-all: ## Para todos containers (projeto atual)
	docker compose stop

container-remove-all: ## Remove todos containers do projeto
	@echo "$(RED)âš ï¸  Isso vai remover TODOS os containers do projeto!$(NC)"
	@read -p "Tem certeza? [s/N]: " confirm; \
	if [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ]; then \
		docker compose down --remove-orphans; \
		echo "$(GREEN)âœ… Containers removidos!$(NC)"; \
	else \
		echo "Cancelado."; \
	fi

container-remove-by-name: ## Remove containers por nome/padrÃ£o
	@read -p "PadrÃ£o do nome (ex: setup-laravel-*): " pattern; \
	docker ps -a --filter "name=$$pattern" --format "{{.ID}}" | xargs -r docker rm -f && \
	echo "$(GREEN)âœ… Containers removidos!$(NC)"

container-inspect-php: ## Inspeciona detalhes do container PHP
	docker inspect setup-laravel-php

container-logs-since: ## Logs desde determinado tempo
	@read -p "Container (php/nginx/mysql/redis): " cont; \
	read -p "Tempo (ex: 10m, 1h, 2024-01-01): " time; \
	docker compose logs --since $$time $$cont

container-export: ## Exporta filesystem do container
	@read -p "Container: " cont; \
	read -p "Nome do arquivo (ex: backup.tar): " file; \
	docker export setup-laravel-$$cont > $$file

container-diff: ## Mostra mudanÃ§as no filesystem
	@read -p "Container (php/nginx/mysql/redis): " cont; \
	docker diff setup-laravel-$$cont


##@ ğŸ“‚ Docker - Arquivos & CÃ³pia

copy-to-php: ## Copia arquivo do host para container PHP
	@read -p "Arquivo local: " src; \
	read -p "Destino no container: " dest; \
	docker cp $$src setup-laravel-php:$$dest

copy-from-php: ## Copia arquivo do container PHP para host
	@read -p "Arquivo no container: " src; \
	read -p "Destino local: " dest; \
	docker cp setup-laravel-php:$$src $$dest

copy-env: ## Copia .env para dentro do container
	docker cp backend/.env setup-laravel-php:/var/www/.env


##@ ğŸ”§ Docker - ManutenÃ§Ã£o

docker-clean: ## Limpeza geral do Docker
	@echo "$(YELLOW)ğŸ§¹ Limpando Docker...$(NC)"
	docker compose down
	docker system prune -f
	@echo "$(GREEN)âœ… Limpeza concluÃ­da!$(NC)"

docker-clean-all: ## Limpeza COMPLETA (âš ï¸ CUIDADO!)
	@echo "$(RED)âš ï¸âš ï¸âš ï¸  REMOVE TUDO DO DOCKER! âš ï¸âš ï¸âš ï¸$(NC)"
	@read -p "Digite 'CONFIRMO' para continuar: " confirm; \
	if [ "$$confirm" = "CONFIRMO" ]; then \
		docker compose down -v; \
		docker system prune -af --volumes; \
		echo "$(GREEN)âœ… Docker completamente limpo!$(NC)"; \
	else \
		echo "Cancelado."; \
	fi

docker-clean-containers: ## Remove containers parados do sistema
	@echo "$(YELLOW)ğŸ§¹ Limpando containers parados...$(NC)"
	docker container prune -f
	@echo "$(GREEN)âœ… Containers limpos!$(NC)"

docker-clean-images: ## Remove imagens nÃ£o utilizadas
	@echo "$(YELLOW)ğŸ§¹ Limpando imagens nÃ£o utilizadas...$(NC)"
	docker image prune -f
	@echo "$(GREEN)âœ… Imagens limpas!$(NC)"

docker-clean-all-images: ## Remove TODAS imagens nÃ£o utilizadas (com tags)
	@echo "$(RED)âš ï¸  Remove todas imagens nÃ£o utilizadas (incluindo com tags)!$(NC)"
	@read -p "Confirma? [s/N]: " confirm; \
	if [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ]; then \
		docker image prune -a -f; \
		echo "$(GREEN)âœ… Imagens removidas!$(NC)"; \
	else \
		echo "Cancelado."; \
	fi

docker-clean-networks: ## Remove networks nÃ£o utilizadas
	@echo "$(YELLOW)ğŸ§¹ Limpando networks nÃ£o utilizadas...$(NC)"
	docker network prune -f
	@echo "$(GREEN)âœ… Networks limpas!$(NC)"

docker-clean-build-cache: ## Remove build cache do Docker
	@echo "$(YELLOW)ğŸ§¹ Limpando build cache...$(NC)"
	docker builder prune -f
	@echo "$(GREEN)âœ… Build cache limpo!$(NC)"

docker-clean-all-cache: ## Remove todo cache do Docker (build + sistema)
	@echo "$(YELLOW)ğŸ§¹ Limpando todo cache...$(NC)"
	docker builder prune -af
	docker system prune -f
	@echo "$(GREEN)âœ… Cache limpo!$(NC)"

docker-info: ## Mostra informaÃ§Ãµes sobre uso do Docker
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(GREEN)ğŸ“Š InformaÃ§Ãµes do Docker$(NC)"
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ’¾ Uso de Disco:$(NC)"
	@docker system df
	@echo ""
	@echo "$(YELLOW)ğŸ³ Containers (parados):$(NC)"
	@docker ps -a --filter "status=exited" --format "table {{.ID}}\t{{.Names}}\t{{.Status}}" || echo "Nenhum container parado"
	@echo ""
	@echo "$(YELLOW)ğŸ–¼ï¸  Imagens (dangling):$(NC)"
	@docker images --filter "dangling=true" --format "table {{.ID}}\t{{.Repository}}\t{{.Tag}}" || echo "Nenhuma imagem Ã³rfÃ£"

docker-rebuild: ## Rebuild completo de todas as imagens
	docker compose down
	docker compose build --no-cache
	docker compose up -d

